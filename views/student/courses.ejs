<%- include('../partials/student-header') %>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">My Courses</h1>
    <span class="badge bg-primary">Student</span>
  </div>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Enrolled Courses</h5>
      <p class="card-text">View all your enrolled courses and attendance statistics.</p>
    </div>
  </div>

  <div class="row">
    <!-- Course Cards -->
    <div class="col-md-4 mb-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">CSC101</h5>
        </div>
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Introduction to Computer Science</h6>
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span>Instructor:</span>
              <span>Dr. John Doe</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span>Schedule:</span>
              <span>Mon, Wed 9:00-10:30</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span>Room:</span>
              <span>CS-101</span>
            </div>
          </div>
          <div class="mb-3">
            <h6>Attendance</h6>
            <div class="progress mb-2">
              <div class="progress-bar bg-success" role="progressbar" style="width: 90%" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="d-flex justify-content-between">
              <small>Present: 18/20 classes</small>
              <small>90%</small>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <a href="#" class="btn btn-sm btn-outline-primary view-details" data-course-id="CSC101">View Details</a>
        </div>
      </div>
    </div>

    <div class="col-md-4 mb-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">MTH201</h5>
        </div>
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Advanced Mathematics</h6>
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span>Instructor:</span>
              <span>Prof. Sarah Johnson</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span>Schedule:</span>
              <span>Tue, Thu 11:00-12:30</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span>Room:</span>
              <span>MTH-201</span>
            </div>
          </div>
          <div class="mb-3">
            <h6>Attendance</h6>
            <div class="progress mb-2">
              <div class="progress-bar bg-success" role="progressbar" style="width: 85%" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="d-flex justify-content-between">
              <small>Present: 17/20 classes</small>
              <small>85%</small>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <a href="#" class="btn btn-sm btn-outline-primary view-details" data-course-id="MTH201">View Details</a>
        </div>
      </div>
    </div>

    <div class="col-md-4 mb-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">PHY102</h5>
        </div>
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Physics Fundamentals</h6>
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span>Instructor:</span>
              <span>Dr. Michael Chen</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span>Schedule:</span>
              <span>Mon, Fri 2:00-3:30</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span>Room:</span>
              <span>PHY-102</span>
            </div>
          </div>
          <div class="mb-3">
            <h6>Attendance</h6>
            <div class="progress mb-2">
              <div class="progress-bar bg-warning" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="d-flex justify-content-between">
              <small>Present: 15/20 classes</small>
              <small>75%</small>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <a href="#" class="btn btn-sm btn-outline-primary view-details" data-course-id="PHY102">View Details</a>
        </div>
      </div>
    </div>

    <div class="col-md-4 mb-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">ENG103</h5>
        </div>
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">English Composition</h6>
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span>Instructor:</span>
              <span>Prof. Emily Wilson</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span>Schedule:</span>
              <span>Wed, Fri 10:00-11:30</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span>Room:</span>
              <span>ENG-103</span>
            </div>
          </div>
          <div class="mb-3">
            <h6>Attendance</h6>
            <div class="progress mb-2">
              <div class="progress-bar bg-success" role="progressbar" style="width: 95%" aria-valuenow="95" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="d-flex justify-content-between">
              <small>Present: 19/20 classes</small>
              <small>95%</small>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <a href="#" class="btn btn-sm btn-outline-primary view-details" data-course-id="ENG103">View Details</a>
        </div>
      </div>
    </div>

    <div class="col-md-4 mb-4">
      <div class="card h-100">
        <div class="card-header bg-primary text-white">
          <h5 class="card-title mb-0">CSC202</h5>
        </div>
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Data Structures</h6>
          <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
              <span>Instructor:</span>
              <span>Dr. Robert Brown</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span>Schedule:</span>
              <span>Tue, Thu 1:00-2:30</span>
            </div>
            <div class="d-flex justify-content-between mb-1">
              <span>Room:</span>
              <span>CS-202</span>
            </div>
          </div>
          <div class="mb-3">
            <h6>Attendance</h6>
            <div class="progress mb-2">
              <div class="progress-bar bg-success" role="progressbar" style="width: 88%" aria-valuenow="88" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <div class="d-flex justify-content-between">
              <small>Present: 22/25 classes</small>
              <small>88%</small>
            </div>
          </div>
        </div>
        <div class="card-footer">
          <a href="#" class="btn btn-sm btn-outline-primary view-details" data-course-id="CSC202">View Details</a>
        </div>
      </div>
    </div>
  </div>

  <div class="card mt-4">
    <div class="card-header">
      <h5 class="card-title mb-0">Attendance Summary</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h6>Overall Attendance</h6>
          <div class="progress mb-2">
            <div class="progress-bar bg-success" role="progressbar" style="width: 87%" aria-valuenow="87" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="d-flex justify-content-between">
            <small>Present: 91/105 classes</small>
            <small>87%</small>
          </div>
        </div>
        <div class="col-md-6">
          <h6>Monthly Trend</h6>
          <canvas id="attendanceChart" height="150"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Course Details Modal -->
  <div class="modal fade" id="courseDetailsModal" tabindex="-1" aria-labelledby="courseDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="courseDetailsModalLabel">Course Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <h6 class="fw-bold">Course Information</h6>
                <table class="table table-borderless">
                  <tr>
                    <td class="text-muted">Course Code:</td>
                    <td id="modal-course-code">-</td>
                  </tr>
                  <tr>
                    <td class="text-muted">Course Name:</td>
                    <td id="modal-course-name">-</td>
                  </tr>
                  <tr>
                    <td class="text-muted">Instructor:</td>
                    <td id="modal-instructor">-</td>
                  </tr>
                  <tr>
                    <td class="text-muted">Schedule:</td>
                    <td id="modal-schedule">-</td>
                  </tr>
                  <tr>
                    <td class="text-muted">Room:</td>
                    <td id="modal-room">-</td>
                  </tr>
                  <tr>
                    <td class="text-muted">Credits:</td>
                    <td id="modal-credits">-</td>
                  </tr>
                </table>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <h6 class="fw-bold">Attendance Summary</h6>
                <div class="progress mb-2">
                  <div id="modal-progress" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                </div>
                <div class="d-flex justify-content-between">
                  <small id="modal-attendance-count">Present: 0/0 classes</small>
                  <small id="modal-attendance-percent">0%</small>
                </div>
              </div>
              <div class="mb-3">
                <h6 class="fw-bold">Monthly Attendance</h6>
                <canvas id="modalAttendanceChart" height="150"></canvas>
              </div>
            </div>
          </div>
          
          <div class="mt-4">
            <h6 class="fw-bold">Recent Attendance</h6>
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Status</th>
                    <th>Verification Method</th>
                  </tr>
                </thead>
                <tbody id="modal-attendance-history">
                  <!-- Will be populated by JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <a href="#" id="modal-full-report" class="btn btn-primary">Full Report</a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Simple chart for attendance trend
  document.addEventListener('DOMContentLoaded', function() {
    const ctx = document.getElementById('attendanceChart').getContext('2d');
    
    // Simulate chart with placeholder
    ctx.beginPath();
    ctx.moveTo(0, 100);
    ctx.lineTo(50, 80);
    ctx.lineTo(100, 90);
    ctx.lineTo(150, 70);
    ctx.lineTo(200, 85);
    ctx.lineTo(250, 60);
    ctx.lineTo(300, 75);
    ctx.strokeStyle = '#0d6efd';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Add labels
    ctx.font = '10px Arial';
    ctx.fillStyle = '#666';
    ctx.fillText('Jan', 0, 120);
    ctx.fillText('Feb', 50, 120);
    ctx.fillText('Mar', 100, 120);
    ctx.fillText('Apr', 150, 120);
    ctx.fillText('May', 200, 120);
    ctx.fillText('Jun', 250, 120);
    ctx.fillText('Jul', 300, 120);
    
    // Course details modal functionality
    const courseDetailsModal = document.getElementById('courseDetailsModal');
    const viewDetailsButtons = document.querySelectorAll('.view-details');
    
    // Mock data for courses
    const coursesData = {
      'CSC101': {
        code: 'CSC101',
        name: 'Introduction to Computer Science',
        instructor: 'Dr. John Doe',
        schedule: 'Mon, Wed 9:00-10:30',
        room: 'CS-101',
        credits: 3,
        attendance: {
          present: 18,
          total: 20,
          percent: 90,
          history: [
            { date: '2023-05-01', time: '09:15 AM', status: 'Present', method: 'QR Code' },
            { date: '2023-04-28', time: '09:10 AM', status: 'Present', method: 'Face Recognition' },
            { date: '2023-04-26', time: '09:05 AM', status: 'Present', method: 'QR Code' },
            { date: '2023-04-24', time: '09:20 AM', status: 'Present', method: 'Face Recognition' },
            { date: '2023-04-21', time: '09:00 AM', status: 'Absent', method: 'N/A' }
          ]
        }
      },
      'MTH201': {
        code: 'MTH201',
        name: 'Advanced Mathematics',
        instructor: 'Prof. Sarah Johnson',
        schedule: 'Tue, Thu 11:00-12:30',
        room: 'MTH-201',
        credits: 4,
        attendance: {
          present: 17,
          total: 20,
          percent: 85,
          history: [
            { date: '2023-05-02', time: '11:05 AM', status: 'Present', method: 'QR Code' },
            { date: '2023-04-27', time: '11:15 AM', status: 'Present', method: 'Face Recognition' },
            { date: '2023-04-25', time: '11:10 AM', status: 'Present', method: 'QR Code' },
            { date: '2023-04-20', time: '11:00 AM', status: 'Absent', method: 'N/A' },
            { date: '2023-04-18', time: '11:20 AM', status: 'Present', method: 'Face Recognition' }
          ]
        }
      },
      'PHY102': {
        code: 'PHY102',
        name: 'Physics Fundamentals',
        instructor: 'Dr. Michael Chen',
        schedule: 'Mon, Fri 2:00-3:30',
        room: 'PHY-102',
        credits: 4,
        attendance: {
          present: 15,
          total: 20,
          percent: 75,
          history: [
            { date: '2023-05-01', time: '02:10 PM', status: 'Present', method: 'QR Code' },
            { date: '2023-04-28', time: '02:05 PM', status: 'Present', method: 'Face Recognition' },
            { date: '2023-04-24', time: '02:15 PM', status: 'Absent', method: 'N/A' },
            { date: '2023-04-21', time: '02:00 PM', status: 'Present', method: 'QR Code' },
            { date: '2023-04-17', time: '02:20 PM', status: 'Absent', method: 'N/A' }
          ]
        }
      },
      'ENG103': {
        code: 'ENG103',
        name: 'English Composition',
        instructor: 'Prof. Emily Wilson',
        schedule: 'Wed, Fri 10:00-11:30',
        room: 'ENG-103',
        credits: 3,
        attendance: {
          present: 19,
          total: 20,
          percent: 95,
          history: [
            { date: '2023-05-03', time: '10:05 AM', status: 'Present', method: 'QR Code' },
            { date: '2023-04-28', time: '10:10 AM', status: 'Present', method: 'Face Recognition' },
            { date: '2023-04-26', time: '10:00 AM', status: 'Present', method: 'QR Code' },
            { date: '2023-04-21', time: '10:15 AM', status: 'Present', method: 'Face Recognition' },
            { date: '2023-04-19', time: '10:05 AM', status: 'Present', method: 'QR Code' }
          ]
        }
      },
      'CSC202': {
        code: 'CSC202',
        name: 'Data Structures',
        instructor: 'Dr. Robert Brown',
        schedule: 'Tue, Thu 1:00-2:30',
        room: 'CS-202',
        credits: 4,
        attendance: {
          present: 22,
          total: 25,
          percent: 88,
          history: [
            { date: '2023-05-02', time: '01:05 PM', status: 'Present', method: 'QR Code' },
            { date: '2023-04-27', time: '01:10 PM', status: 'Present', method: 'Face Recognition' },
            { date: '2023-04-25', time: '01:00 PM', status: 'Present', method: 'QR Code' },
            { date: '2023-04-20', time: '01:15 PM', status: 'Absent', method: 'N/A' },
            { date: '2023-04-18', time: '01:05 PM', status: 'Present', method: 'Face Recognition' }
          ]
        }
      }
    };
    
    // Function to populate modal with course data
    function populateCourseModal(courseId) {
      const course = coursesData[courseId];
      if (!course) return;
      
      // Update modal title
      document.getElementById('courseDetailsModalLabel').textContent = `${course.code}: ${course.name}`;
      
      // Update course information
      document.getElementById('modal-course-code').textContent = course.code;
      document.getElementById('modal-course-name').textContent = course.name;
      document.getElementById('modal-instructor').textContent = course.instructor;
      document.getElementById('modal-schedule').textContent = course.schedule;
      document.getElementById('modal-room').textContent = course.room;
      document.getElementById('modal-credits').textContent = course.credits;
      
      // Update attendance information
      const progressBar = document.getElementById('modal-progress');
      progressBar.style.width = `${course.attendance.percent}%`;
      progressBar.setAttribute('aria-valuenow', course.attendance.percent);
      
      // Set progress bar color based on percentage
      if (course.attendance.percent >= 90) {
        progressBar.className = 'progress-bar bg-success';
      } else if (course.attendance.percent >= 75) {
        progressBar.className = 'progress-bar bg-warning';
      } else {
        progressBar.className = 'progress-bar bg-danger';
      }
      
      document.getElementById('modal-attendance-count').textContent = 
        `Present: ${course.attendance.present}/${course.attendance.total} classes`;
      document.getElementById('modal-attendance-percent').textContent = 
        `${course.attendance.percent}%`;
      
      // Populate attendance history table
      const historyTableBody = document.getElementById('modal-attendance-history');
      historyTableBody.innerHTML = '';
      
      course.attendance.history.forEach(record => {
        const row = document.createElement('tr');
        
        const dateCell = document.createElement('td');
        dateCell.textContent = record.date;
        row.appendChild(dateCell);
        
        const timeCell = document.createElement('td');
        timeCell.textContent = record.time;
        row.appendChild(timeCell);
        
        const statusCell = document.createElement('td');
        const statusBadge = document.createElement('span');
        statusBadge.className = `badge ${record.status === 'Present' ? 'bg-success' : 'bg-danger'}`;
        statusBadge.textContent = record.status;
        statusCell.appendChild(statusBadge);
        row.appendChild(statusCell);
        
        const methodCell = document.createElement('td');
        methodCell.textContent = record.method;
        row.appendChild(methodCell);
        
        historyTableBody.appendChild(row);
      });
      
      // Set up the chart
      const modalCtx = document.getElementById('modalAttendanceChart').getContext('2d');
      
      // Clear previous chart
      modalCtx.clearRect(0, 0, modalCtx.canvas.width, modalCtx.canvas.height);
      
      // Draw new chart (simplified for this example)
      modalCtx.beginPath();
      modalCtx.moveTo(0, 50);
      modalCtx.lineTo(40, 30);
      modalCtx.lineTo(80, 40);
      modalCtx.lineTo(120, 20);
      modalCtx.lineTo(160, 35);
      modalCtx.lineTo(200, 25);
      modalCtx.lineTo(240, 30);
      modalCtx.strokeStyle = '#0d6efd';
      modalCtx.lineWidth = 2;
      modalCtx.stroke();
      
      // Add labels
      modalCtx.font = '10px Arial';
      modalCtx.fillStyle = '#666';
      modalCtx.fillText('Week 1', 0, 70);
      modalCtx.fillText('Week 2', 40, 70);
      modalCtx.fillText('Week 3', 80, 70);
      modalCtx.fillText('Week 4', 120, 70);
      modalCtx.fillText('Week 5', 160, 70);
      modalCtx.fillText('Week 6', 200, 70);
      modalCtx.fillText('Week 7', 240, 70);
      
      // Update full report link
      document.getElementById('modal-full-report').href = `/student/courses/${courseId}/report`;
    }
    
    // Add click event listeners to all "View Details" buttons
    viewDetailsButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        const courseId = this.getAttribute('data-course-id');
        populateCourseModal(courseId);
        
        // Show the modal
        const modal = new bootstrap.Modal(courseDetailsModal);
        modal.show();
      });
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<%- include('../partials/footer') %>
